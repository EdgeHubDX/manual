{%- assign nav_order_pages = site.pages
  | where_exp: "item", "item.nav_order != nil" -%}
{%- assign title_order_pages = site.pages
  | where_exp: "item", "item.nav_order == nil" -%}

{%- assign double_quote = '"' -%}
{%- assign empty_array = "" | split: "" -%}

{%- assign nav_string_pages = empty_array -%}
{%- assign nav_number_pages = empty_array -%}
{%- unless nav_order_pages == empty -%}
{%- assign nav_order_groups = nav_order_pages
    | group_by_exp: "item",
        "item.nav_order | jsonify | slice: 0 | remove: double_quote | size" -%}
{%- for group in nav_order_groups -%}
{%- if group.name == 0 -%}
  {%- assign nav_string_pages = group.items -%}
{%- elsif group.name == 1 -%}
  {%- assign nav_number_pages = group.items -%}
{%- endif -%}
{%- endfor -%}
{%- endunless -%}

{%- assign title_string_pages = empty_array -%}
{%- assign title_number_pages = empty_array -%}
{%- unless title_order_pages == empty -%}
{%- assign title_order_groups = title_order_pages
    | group_by_exp: "item",
        "item.title | jsonify | slice: 0 | remove: double_quote | size" -%}
{%- for group in title_order_groups -%}
{%- if group.name == 0 -%}
  {%- assign title_string_pages = group.items -%}
{%- elsif group.name == 1 -%}
  {%- assign title_number_pages = group.items -%}
{%- endif -%}
{%- endfor -%}
{%- endunless -%}

{%- unless nav_number_pages == empty -%}
{%- assign nav_number_pages = nav_number_pages | sort: "nav_order" -%}
{%- endunless -%}

{%- unless nav_string_pages == empty -%}
{%- if site.nav_sort == 'case_insensitive' -%}
{%- assign nav_string_pages = nav_string_pages | sort_natural: "nav_order" -%}
{%- else -%}
{%- assign nav_string_pages = nav_string_pages | sort: "nav_order" -%}
{%- endif -%}
{%- endunless -%}

{%- unless title_number_pages == empty -%}
{%- assign title_number_pages = title_number_pages | sort: "title" -%}
{%- endunless -%}

{%- unless title_string_pages == empty -%}
{%- if site.nav_sort == 'case_insensitive' -%}
{%- assign title_string_pages = title_string_pages | sort_natural: "title" -%}
{%- else -%}
{%- assign title_string_pages = title_string_pages | sort: "title" -%}
{%- endif -%}
{%- endunless -%}

{%- assign sorted_pages = nav_number_pages
  | concat: nav_string_pages
  | concat: title_number_pages
  | concat: title_string_pages -%}

{%- assign first_level_pages = sorted_pages
  | where_exp: "item", "item.parent == nil" -%}
{%- assign second_level_pages = sorted_pages
  | where_exp: "item", "item.parent != nil"
  | where_exp: "item", "item.grand_parent == nil" -%}
{%- assign third_level_pages = sorted_pages
  | where_exp: "item", "item.grand_parent != nil" -%}

<ul class="nav-list">
  {%- for node in first_level_pages -%}
    <li class="nav-list-item">
      {%- if node.has_children -%}
      <button class="nav-list-expander btn-reset" aria-label="toggle items in {{ node.title }} category" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
      </button>
      {%- endif -%}
      <a href="{{ node.url | relative_url }}" class="nav-list-link">{{ node.title }}</a>
      {%- if node.has_children -%}
        {%- assign children_list = second_level_pages
              | where: "parent", node.title -%}
        {%- if node.child_nav_order == 'desc' or node.child_nav_order == 'reversed' -%}
          {%- assign children_list = children_list | reverse -%}
        {%- endif -%}
        <ul class="nav-list">
        {%- for child in children_list -%}
          <li class="nav-list-item">
            {%- if child.has_children -%}
            <button class="nav-list-expander btn-reset" aria-label="toggle items in {{ child.title }} category" aria-pressed="false">
              <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
            </button>
            {%- endif -%}
            <a href="{{ child.url | relative_url }}" class="nav-list-link">{{ child.title }}</a>
            {%- if child.has_children -%}
              {%- assign grand_children_list = third_level_pages
                    | where: "parent", child.title
                    | where: "grand_parent", node.title -%}
              {%- if child.child_nav_order == 'desc' or child.child_nav_order == 'reversed' -%}
                {%- assign grand_children_list = grand_children_list | reverse -%}
              {%- endif -%}
              <ul class="nav-list">
              {%- for grand_child in grand_children_list -%}
                <li class="nav-list-item">
                  <a href="{{ grand_child.url | relative_url }}" class="nav-list-link">{{ grand_child.title }}</a>
                </li>
              {%- endfor -%}
              </ul>
            {%- endif -%}
          </li>
        {%- endfor -%}
        </ul>
      {%- endif -%}
    </li>
  {%- endfor -%}
</ul>